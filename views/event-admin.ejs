<!DOCTYPE html>
<html lang="en">

<head>
<%- include('header'); %>
  <title>odette.rsvp - editing <%= event.title %></title>
  <!-- DataTables CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <%- include('admin-preload'); %>

</head>

<body>
  <header class="container">
    <h1>üíå odette.rsvp</h1>
  <nav aria-label="breadcrumb">
    <ul>
      <li><a href="/admin">My events</a></li>
      <li><%= event.title %></li>
    </ul>
  </nav>
  </header>

  <main class="container">


    <style>
      article.rsvp-summary > .grid > div {
        padding:calc(var(--pico-spacing)/ 2) 0;
        border-radius:var(--pico-border-radius);
        background-color:var(--pico-code-background-color);
        color:var(--pico-muted-color);
        font-size:.875rem;
        text-align:center
      }

      details[open] > summary {
        margin-bottom: 0;
      }
    </style>

    <details>
      <summary role="button">Edit event details</summary>

    <!-- Edit Event Details Section -->
    <article>
      <% if (locals.error) { %>
        <p style="color: red;"><%= locals.error %></p>
      <% } %>
      <form action="/admin/event/<%= event.id %>/update" method="POST" enctype="multipart/form-data" id="editEventForm">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <div>
          <label for="title">Event Title:</label>
          <input type="text" id="title" name="title" value="<%= event.title %>" required />
        </div>
        <div>
          <label for="date">Start Date & Time:</label>
          <input type="datetime-local" id="date" name="date" data-timestamp="<%= event.date %>" required />
        </div>
        <div>
          <label for="date_end">End Date & Time (Optional):</label>
          <input type="datetime-local" id="date_end" name="date_end" data-timestamp="<%= event.date_end %>" />
        </div>
        <div>
          <%- include('timezone-select', { labelText: 'Event Timezone', inputId: 'timezone', selectedTimezone: event.timezone }); %>
        </div>
        <div>
          <label for="location_name">Location Name (Optional):</label>
          <input type="text" id="location_name" name="location_name" value="<%= event.location_name || '' %>" />
        </div>
        <div>
          <label for="location_href">Location URL (Optional):</label>
          <input type="url" id="location_href" name="location_href" value="<%= event.location_href || '' %>" placeholder="https://maps.example.com/..." />
        </div>
        <div>
          <label for="description">Description:</label>
          <textarea id="description" name="description" rows="3"><%= event.description || '' %></textarea>
        </div>
        <div>
          <label for="banner_image">Event Banner Image (Optional):</label>
          <% if (event.banner_image_filename) { %>
            <p>Current Banner:</p>
            <img src="/uploads/event-banners/<%= event.banner_image_filename %>" alt="Current Event Banner" class="current-banner-image">
            <p><small>Uploading a new image will replace the current one.</small></p>
          <% } else { %>
            <p><small>No banner image uploaded yet.</small></p>
          <% } %>
          <input type="file" id="banner_image" name="banner_image" accept="image/png, image/jpeg, image/gif">
        </div>
        <button type="submit" class="action-button">Update Event Details</button>
      </form>
    </article>
     </details>


   <!--
   <hr style="margin: 20px 0;">
    <p class="date">Current Start Date & Time (Server Local): <%= new Date(event.date).toLocaleString() %></p>
    <% if (event.date_end) { %>
      <p class="date">Current End Date & Time (Server Local): <%= new Date(event.date_end).toLocaleString() %></p>
    <% } %>
    <p class="timezone">Current Event Timezone for Emails: <%= event.timezone || 'Server Default' %></p>
    <% if (event.location_name || event.location_href) { %>
      <p class="location">
        Current Location: 
        <% if (event.location_href) { %>
          <a href="<%= event.location_href %>" target="_blank"><%= event.location_name || 'View Map' %></a>
        <% } else { %>
          <%= event.location_name %>
        <% } %>
      </p>
    <% } %>
    <% if (event.description) { %>
      <p class="description">Current Description: <%- event.description %></p>
    <% } %>


    <div class="form-section">
      <form action="/admin/events/<%= event.id %>/send-invites" method="POST" style="margin-bottom: 20px;">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <button type="submit" class="action-button" <% if (typeof attendeeStats !== 'undefined' && attendeeStats.guestsNotSent === 0) { %>disabled<% } %>>
          Send All Pending Invites for This Event
        </button>
        <% if (typeof attendeeStats !== 'undefined' && attendeeStats.guestsNotSent === 0) { %>
          <small>(No pending invites to send)</small>
        <% } %>
      </form>
    </div>


-->

    <details >
      <summary role="button">Invite someone</summary>
    <!-- Attendees Section -->
     <article>
          <form action="/admin/attendee" method="POST">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <input type="hidden" name="event_id" value="<%= event.id %>" />
            <input type="hidden" name="token" />  <%# TODO: very beginning of turning this into an edit/update form as well as an insert form %>
            <label for="name">Name:</label>
            <input type="text" id="name" name="name" required />
            
            <label for="email">Primary Email:</label>
            <input type="email" id="email" name="email" required />
            
            <label for="additional_emails">Additional Emails (one per line or comma-separated):</label>
            <textarea id="additional_emails" name="additional_emails" rows="3" placeholder="friend@example.com, colleague@work.com"></textarea>
            
            <label for="party_size_single">Party Size:</label>
            <input type="number" id="party_size_single" name="party_size" value="1" min="1" required />
            <button type="submit">Add Attendee</button>
          </form>
        </article>
    </details>

    <details>
      <summary role="button">Invite many people</summary>
      <article>
      <!-- Parse Email Addresses from "To:" Field -->
      <div class="mt-20 mb-20">
        <h3>Parse Email Addresses from "To:" Field</h3>
        <p class="text-muted" style="font-size: 0.9em; margin-bottom: 10px;">
          Paste a list of email recipients (e.g., from an email's "To:" or "Cc:" field).<br>
          Each will be added with a party size of 1. Deduplicates based on email address.<br>
        </p>
        <form action="/admin/event/<%= event.id %>/attendees/parse-emails" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <label for="email_field_data">Paste Email Field Content:</label>
          <textarea id="email_field_data" name="email_field_data" rows="5" placeholder="&quot;Friendly Name&quot; &lt;name@example.com&gt;, another@example.org, Person &lt;person@server.com&gt;" required style="width: 100%; box-sizing: border-box; margin-top: 5px; margin-bottom: 10px;"></textarea>
          <button type="submit">Parse and Add Attendees</button>
        </form>
      </div>
      </article></details>

      <!-- END NEW FORM SECTION -->

      <% if (allEvents.length > 0) { %>
      <details>
        <summary role="button">Copy attendees from another event</summary>
      <article> 
        <form action="/admin/attendees/copy" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" name="to_event" value="<%= event.id %>" />
          <label for="from_event">Copy Attendees From Event:</label>
          <select id="from_event" name="from_event" required>
            <% allEvents.forEach(otherEvent => { %>
              <option value="<%= otherEvent.id %>"><%= otherEvent.title %></option>
            <% }) %>
          </select>
          <button type="submit">Copy Attendees</button>
        </form>
      </article>
      </details>
      <% } %>


          <!-- RSVP Summary Section -->
    <% if (typeof attendeeStats !== 'undefined') { %>
    <section>
      <article class="rsvp-summary">
        <header>
          <h3>Response summary</h3>
        </header>
        <section class="grid">
          <div><header>
            <strong>Potential Guests:</strong></header> <%= attendeeStats.potentialGuests %>
          </div>
          <div><header>
            <strong>Invites Not Sent:</strong> </header> <%= attendeeStats.guestsNotSent %>
          </div>
          <div> <header>
            <strong>Invites Sent:</strong> </header> <%= attendeeStats.guestsInvited %>
          </div>
        </section><section class="grid">  <%# is there a better way to do this? %>
          <div><header>
            <strong>Awaiting Reply:</strong> </header> <%= attendeeStats.guestsAwaitingReply %>
          </div>
          <div> <header>
            <strong>Attending:</strong> </header> <%= attendeeStats.guestsAttending %>
          </div>
          <div> <header>
            <strong>Not Attending:</strong> </header> <%= attendeeStats.guestsNotAttending %>
          </div>
        </section>
    </section>
    <% } %>

      <h3>Responses</h3>
      <% if (attendees.length > 0) { %>
        <table id="attendeesTable" class="display">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email(s)</th>
              <th>Party Size</th>
              <th>Invite Sent?</th>
              <th>RSVP Status</th>
              <th>Responded At</th>
              <th>Last Modified</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% attendees.forEach(attendee => { %>
              <% 
                let additionalEmailsArray = [];
                if (attendee.additional_emails) {
                  try {
                    const parsed = JSON.parse(attendee.additional_emails);
                    if (Array.isArray(parsed)) {
                      additionalEmailsArray = parsed.filter(e => typeof e === 'string' && e.trim() !== '');
                    }
                  } catch(e) { /* ignore parsing error for data attribute */ }
                }
              %>
              <tr>
                <td><%= attendee.name %></td>
                <td class="email-list">
                  <strong><%= attendee.email %></strong> <!-- Primary -->
                  <% if (additionalEmailsArray.length > 0) { %>
                    <% additionalEmailsArray.forEach(addEmail => { %><small><%= addEmail %></small><% }); %>
                  <% } %>
                </td>
                <td data-order="<%= attendee.party_size %>">
                  <% if (!attendee.rsvp) { %>
                    <form action="/admin/attendee/<%= attendee.id %>/update-party-size" method="POST" class="party-size-form" style="display: inline-flex; align-items: center;">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <input type="number" name="party_size" value="<%= attendee.party_size %>" min="1" required style="width: 60px; margin-right: 5px;">
                      <button type="submit">Update</button>
                    </form>
                  <% } else { %>
                    <%= attendee.party_size %>
                  <% } %>
                </td>
                <td>
                  <% if (attendee.is_sent) { %>
                    <a href="/rsvp/<%= attendee.token %>" target="_blank">Yes</a>
                  <% } else { %>
                    No
                  <% } %>
                </td>
                <% 
                  let rsvpStatusText = 'Pending';
                  let rsvpBadgeClass = 'badge-warning';
                  let rsvpSortOrder = 1; 
                  if (attendee.rsvp === 'yes') {
                    rsvpStatusText = 'YES';
                    rsvpBadgeClass = 'badge-success';
                    rsvpSortOrder = 2;
                  } else if (attendee.rsvp === 'no') {
                    rsvpStatusText = 'NO';
                    rsvpBadgeClass = 'badge-danger';
                    rsvpSortOrder = 3;
                  }
                %>
                <td data-order="<%= rsvpSortOrder %>">
                  <span class="badge <%= rsvpBadgeClass %>"><%= rsvpStatusText %></span>
                </td>
                <td data-order="<%= attendee.responded_at || 0 %>">
                  <% if (attendee.responded_at) { %>
                    <%= new Date(attendee.responded_at).toLocaleString() %>
                  <% } else { %>
                    N/A
                  <% } %>
                </td>
                <td data-order="<%= attendee.last_modified || 0 %>">
                  <% if (attendee.last_modified) { %>
                    <%= new Date(attendee.last_modified).toLocaleString() %>
                  <% } else { %>
                    N/A
                  <% } %>
                </td>
                <td>
                  <div class="btn-group">
                    <% if (!attendee.is_sent) { %>
                      <form action="/admin/attendees/send/<%= attendee.id %>" method="POST" style="display: inline;">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <button type="submit" class="btn-icon btn-success" title="Send Invite">‚úâÔ∏è</button>
                      </form>
                    <% } else { %>
                      <form action="/admin/attendees/send/<%= attendee.id %>" method="POST" style="display: inline;">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <input type="hidden" name="resend" value="1">
                        <button type="submit" class="btn-icon btn-primary" title="Re-send Invite">üîÑ</button>
                      </form>
                    <% } %>
                    <button type="button" class="btn-icon edit-emails-button" title="Edit Details"
                            data-attendee-id="<%= attendee.id %>"
                            data-attendee-name="<%= attendee.name %>"
                            data-primary-email="<%= attendee.email %>"
                            data-additional-emails="<%= additionalEmailsArray.join('\n') %>">‚úèÔ∏è</button>
                    <form action="/admin/attendee/<%= attendee.id %>/delete" method="POST" style="display: inline;" class="delete-attendee-form">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <button type="submit" class="btn-icon btn-danger" title="Delete">üóëÔ∏è</button>
                    </form>
                  </div>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } else { %>
        <p>No attendees added yet for this event.</p>
      <% } %>
    </div>
  </div>

  <!-- Edit Details Modal -->
  <div id="editEmailsModal" class="modal"> <!-- Bulma: add 'is-active' to show -->
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Edit Details for <span id="modalAttendeeTitleName"></span></p>
        <button class="delete" aria-label="close" id="closeEditEmailsModalTop"></button>
      </header>
      <section class="modal-card-body">
        <form id="editEmailsForm" method="POST"> <!-- Action will be set by JS -->
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" id="modalAttendeeId" name="attendeeId">
          
          <div class="field">
            <label class="label" for="modalAttendeeNameInput">Name:</label>
            <div class="control">
              <input class="input" type="text" id="modalAttendeeNameInput" name="name" required>
            </div>
          </div>

          <div class="field">
            <label class="label" for="modalPrimaryEmail">Primary Email:</label>
            <div class="control">
              <input class="input" type="email" id="modalPrimaryEmail" name="primaryEmail" required>
            </div>
          </div>
          
          <div class="field">
            <label class="label" for="modalAdditionalEmails">Additional Emails (one per line):</label>
            <div class="control">
              <textarea class="textarea" id="modalAdditionalEmails" name="additionalEmails" rows="4"></textarea>
            </div>
          </div>
        </form>
      </section>
      <footer class="modal-card-foot">
        <button type="submit" class="button is-success" form="editEmailsForm">Save changes</button>
        <button type="button" class="button" id="cancelEditEmailsModalBottom">Cancel</button>
      </footer>
    </div>
  </div>


  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <!-- Admin JS -->
  <script src="/static/admin.js"></script>

  <script>
    // Page-specific DataTables and modal initialization
    $(document).ready(function() {
      $('#attendeesTable').DataTable({
        "order": [[ 6, "desc" ]], // Default sort by "Last Modified" descending
        "pageLength": 25
      });

      // Edit Details Modal Logic
      const editDetailsModalElement = document.getElementById('editEmailsModal'); // Keep ID for now, or rename if preferred
      const closeEditDetailsModalButtonTop = document.getElementById('closeEditEmailsModalTop');
      const cancelEditDetailsModalButtonBottom = document.getElementById('cancelEditEmailsModalBottom');
      const editDetailsFormElement = document.getElementById('editEmailsForm');
      const modalAttendeeTitleNameSpan = document.getElementById('modalAttendeeTitleName');
      const modalAttendeeIdInput = document.getElementById('modalAttendeeId');
      const modalAttendeeNameInput = document.getElementById('modalAttendeeNameInput'); // New input for name
      const modalPrimaryEmailInput = document.getElementById('modalPrimaryEmail');
      const modalAdditionalEmailsTextarea = document.getElementById('modalAdditionalEmails');

      // Use event delegation for edit buttons on the attendees table
      $('#attendeesTable tbody').on('click', '.edit-emails-button', function() {
          const attendeeId = $(this).data('attendee-id');
          const attendeeName = $(this).data('attendee-name');
          const primaryEmail = $(this).data('primary-email');
          const additionalEmails = $(this).data('additional-emails'); 

          modalAttendeeTitleNameSpan.textContent = attendeeName; // For the modal title
          modalAttendeeIdInput.value = attendeeId;
          modalAttendeeNameInput.value = attendeeName; // Populate the name input field
          modalPrimaryEmailInput.value = primaryEmail;
          modalAdditionalEmailsTextarea.value = additionalEmails;
          
          editDetailsFormElement.action = `/admin/attendee/${attendeeId}/update-emails`; // Route can remain for now
          
          if (editDetailsModalElement) { 
            editDetailsModalElement.classList.add('is-active');
          }
      });

      function closeEditDetailsModal() {
        if (editDetailsModalElement) { 
            editDetailsModalElement.classList.remove('is-active');
        }
      }

      if(closeEditDetailsModalButtonTop) closeEditDetailsModalButtonTop.addEventListener('click', closeEditDetailsModal);
      if(cancelEditDetailsModalButtonBottom) cancelEditDetailsModalButtonBottom.addEventListener('click', closeEditDetailsModal);
      
      const modalBackground = editDetailsModalElement ? editDetailsModalElement.querySelector('.modal-background') : null;
      if(modalBackground) modalBackground.addEventListener('click', closeEditDetailsModal);
    });
  </script>
</body>
</html>
