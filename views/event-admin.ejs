<%# SPDX-License-Identifier: AGPL-3.0-or-later %>
<%# Copyright (C) 2025 Chris Danis %>
<!DOCTYPE html>
<html lang="en">

<head>
<%- include('header'); %>
  <title>odette.rsvp - editing <%= event.title %></title>
  <!-- DataTables CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <%- include('admin-preload'); %>

  <style>
    article.rsvp-summary > .grid > div {
      padding: calc(var(--pico-spacing) / 2) 0;
      border-radius: var(--pico-border-radius);
      background-color: var(--pico-code-background-color);
      color: var(--pico-muted-color);
      font-size: .875rem;
      text-align: center;
    }
    
    .email-list {
      /* display: flex; */
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .btn-group {
      display: flex;
      gap: 0.25rem;
    }
    
    .btn-icon {
      padding: 0.25rem 0.5rem;
      font-size: 1rem;
      border: none;
      background: transparent;
      cursor: pointer;
    }
    
    .current-banner-image {
      /* max-width: 100%;
      max-height: 200px; */
      max-width: 40vw;
      max-height: 33vh;  /* TODO: it should be allowed to grow to the size of its parent if the parent fits? */
      object-fit: contain;
      width: 100%;
      /*margin: 1rem 0;
      border-radius: var(--pico-border-radius); */
    }
    
    dialog article {
      max-width: 600px;
      max-height: 85vh;
      overflow-y: auto;
    }
    
    dialog h3 {
      margin-top: 0;
    }
  </style>
</head>

<body>
  <header class="container">
    <h1>üíå odette.rsvp</h1>
    <nav aria-label="breadcrumb">
      <ul>
        <li><a href="/admin">My events</a></li>
        <li><%= event.title %></li>
      </ul>
    </nav>
  </header>

  <main class="container">
    <% if (locals.error) { %>
      <p style="color: var(--pico-color-red-500);"><%= locals.error %></p>
    <% } %>

    <style>
      article[class="grid"] > article {
        margin-bottom: 0;
      }
    </style>
    <section>
    <article class="grid" style="margin-bottom: 0;">
<%# Event Preview Card: this includes an <article> start tag but not the end tag %>
      <%- include('event-display', { 
          event: event, 
          showIcsDownload: false,
          timeElementId: 'event-preview-time',
          endTimeElementId: 'event-preview-end-time',
          bannerClass: 'current-banner-image'
      }) %>
      
      <footer>
        <button onclick="openEditEventModal()">‚úèÔ∏è Edit Event Details</button>
      </footer>
    </article>
  </section>

    <!-- RSVP Summary Section -->
    <% if (typeof attendeeStats !== 'undefined') { %>
      <style>
        article.rsvp-summary>section>div>header {
          font-size: 1.5rem;
        }
      </style>
      <article class="rsvp-summary">
        <header>
          <h3>Response summary</h3>
        </header>
        <section class="grid">
          <% 
            const now = Date.now();
            const eventDate = new Date(event.date);
            const daysUntil = Math.ceil((event.date - now) / (1000 * 60 * 60 * 24));
            const daysText = daysUntil === 0 ? 'Today!' : daysUntil === 1 ? '1 day' : daysUntil < 0 ? `${Math.abs(daysUntil)} days ago` : `${daysUntil} days`;
          %>
          <div>
            <header><strong><%= daysText %></strong></header>
            until event
          </div>
          <div>
            <header><strong><%= attendeeStats.potentialGuests %></strong></header>
            potential guests
          </div>
          <div>
            <header><strong><%= attendeeStats.guestsAttending %></strong></header>
            accepts
          </div>
          <div>
            <header><strong><%= attendeeStats.guestsNotAttending %></strong></header>
            regrets
          </div>
        </section>
        <footer>
    <!-- Action Buttons -->
    <section class="grid">
      <button onclick="openAddAttendeeModal()">üë§ Invite Someone</button>
      <button onclick="openImportContactsModal()">üìã Invite Lots</button>
    </section>
    <section>
      <form action="/admin/events/<%= event.id %>/send-invites" method="POST">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <button type="submit" <% if (attendeeStats.guestsNotSent === 0) { %>disabled<% } %>>
          üì® Send All Pending Invites (<%= attendeeStats.guestsNotSent %>)
        </button>
      </form>
    </section>
        </footer>
      </article>
    <% } %>

    <h3>Attendees</h3>
      <% if (attendees.length > 0) { %>
        <table id="attendeesTable" class="display">
          <style>
            .dataTables_wrapper .dataTables_filter input {
              padding-inline-start: calc(var(--pico-form-element-spacing-horizontal) + 1.75rem);
              border-radius: 15px;
            }
          </style>
          <thead>
            <tr>
              <th>Name</th>
              <th>Email(s)</th>
              <th>Party Size</th>
              <th>RSVP Status</th>
              <th>Last Modified</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% attendees.forEach(attendee => { %>
              <% 
                let additionalEmailsArray = [];
                if (attendee.additional_emails) {
                  try {
                    const parsed = JSON.parse(attendee.additional_emails);
                    if (Array.isArray(parsed)) {
                      additionalEmailsArray = parsed.filter(e => typeof e === 'string' && e.trim() !== '');
                    }
                  } catch(e) { /* ignore parsing error for data attribute */ }
                }
              %>
              <tr>
                <td>
                  <% if (attendee.is_sent) { %>
                    <a href="/rsvp/<%= attendee.token %>" target="_blank"><%= attendee.name %></a>
                  <% } else { %>
                    <%= attendee.name %>
                  <% } %>
                </td>
                <td class="email-list">
                  <strong><%= attendee.email %></strong> <!-- Primary -->
                  <% if (additionalEmailsArray.length > 0) { %>
                    <% additionalEmailsArray.forEach(addEmail => { %><br/><small><%= addEmail %></small><% }); %>
                  <% } %>
                </td>
                <td data-order="<%= attendee.party_size %>">
                  <% if (!attendee.rsvp) { %>
                    <form action="/admin/attendee/<%= attendee.id %>/update-party-size" method="POST" class="party-size-form" style="display: inline-flex; align-items: center;">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <input type="number" name="party_size" value="<%= attendee.party_size %>" min="1" required style="width: 5em;">
                      <button type="submit">Update</button>
                    </form>
                  <% } else { %>
                    <%= attendee.party_size %>
                  <% } %>
                </td>
                <% 
                  let rsvpStatusText = 'Not Sent';
                  let rsvpBadgeClass = 'badge-secondary';
                  let rsvpSortOrder = 0; 
                  
                  if (attendee.is_sent && !attendee.rsvp) {
                    rsvpStatusText = 'Pending';
                    rsvpBadgeClass = 'badge-secondary';
                    rsvpSortOrder = 1;
                  } else if (attendee.rsvp === 'yes') {
                    rsvpStatusText = 'YES';
                    rsvpBadgeClass = 'badge-success';
                    rsvpSortOrder = 2;
                  } else if (attendee.rsvp === 'no') {
                    rsvpStatusText = 'NO';
                    rsvpBadgeClass = 'badge-danger';
                    rsvpSortOrder = 3;
                  }
                %>
                <td data-order="<%= rsvpSortOrder %>">
                  <span class="badge <%= rsvpBadgeClass %>"><%= rsvpStatusText %></span>
                </td>
                <td data-order="<%= attendee.last_modified || 0 %>">
                  <% if (attendee.last_modified) { %>
                    <%= new Date(attendee.last_modified).toLocaleString() %>
                  <% } else { %>
                    N/A
                  <% } %>
                </td>
                <td>
                  <div class="btn-group">
                    <% if (!attendee.is_sent) { %>
                      <form action="/admin/attendees/send/<%= attendee.id %>" method="POST" style="display: inline;">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <button type="submit" class="btn-icon btn-success" title="Send Invite">‚úâÔ∏è</button>
                      </form>
                    <% } else { %>
                      <form action="/admin/attendees/send/<%= attendee.id %>" method="POST" style="display: inline;">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <input type="hidden" name="resend" value="1">
                        <button type="submit" class="btn-icon btn-primary" title="Re-send Invite">üîÑ</button>
                      </form>
                    <% } %>
                    <button type="button" class="btn-icon" title="Edit Details" onclick="openEditAttendeeModal(<%= attendee.id %>, '<%= attendee.name.replace(/'/g, "\\'") %>', '<%= attendee.email %>', `<%= additionalEmailsArray.join('\n') %>`)">‚úèÔ∏è</button>
                    <form action="/admin/attendee/<%= attendee.id %>/delete" method="POST" style="display: inline;" onsubmit="return confirm('Delete <%= attendee.name.replace(/'/g, "\\'") %>?');">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <button type="submit" class="btn-icon" title="Delete">üóëÔ∏è</button>
                    </form>
                  </div>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } else { %>
        <p>No attendees added yet for this event.</p>
      <% } %>

  <!-- Edit Event Details Modal -->
  <dialog id="editEventModal" onclick="if (event.target === this) closeEditEventModal()">
    <article>
      <header>
        <button aria-label="Close" rel="prev" onclick="closeEditEventModal()"></button>
        <h3>Edit Event Details</h3>
      </header>
      <form action="/admin/event/<%= event.id %>/update" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        
        <label>
          Event Title
          <input type="text" name="title" value="<%= event.title %>" required />
        </label>
        
        <label>
          Start Date & Time
          <input type="datetime-local" name="date" id="edit-date" data-timestamp="<%= event.date %>" required />
        </label>
        
        <label>
          End Date & Time (Optional)
          <input type="datetime-local" name="date_end" id="edit-date-end" data-timestamp="<%= event.date_end %>" />
        </label>
        
        <%- include('timezone-select', { labelText: 'Event Timezone', inputId: 'edit-timezone', selectedTimezone: event.timezone }); %>
        
        <label>
          Location Name (Optional)
          <input type="text" name="location_name" value="<%= event.location_name || '' %>" />
        </label>
        
        <label>
          Location URL (Optional)
          <input type="url" name="location_href" value="<%= event.location_href || '' %>" placeholder="https://maps.example.com/..." />
        </label>
        
        <label>
          Description
          <textarea name="description" rows="4"><%= event.description || '' %></textarea>
        </label>
        
        <label>
          Event Banner Image (Optional)
          <% if (event.banner_image_filename) { %>
            <img src="/uploads/event-banners/<%= event.banner_image_filename %>" alt="Current Event Banner" class="current-banner-image">
            <small>Uploading a new image will replace the current one.</small>
          <% } else { %>
            <small>No banner image uploaded yet.</small>
          <% } %>
          <input type="file" name="banner_image" accept="image/png, image/jpeg, image/gif">
        </label>
        
        <footer class="grid">
          <button type="button" class="secondary" onclick="closeEditEventModal()">Cancel</button>
          <button type="submit">Update Event</button>
        </footer>
      </form>
    </article>
  </dialog>

  <!-- Attendee Modal (Add/Edit) -->
  <dialog id="attendeeModal" onclick="if (event.target === this) closeAttendeeModal()">
    <article>
      <header>
        <button aria-label="Close" rel="prev" onclick="closeAttendeeModal()"></button>
        <h3 id="attendeeModalTitle">Invite Someone</h3>
      </header>
      <form id="attendeeForm" method="POST">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <input type="hidden" name="event_id" value="<%= event.id %>" />
        
        <label>
          Name
          <input type="text" id="attendee-name" name="name" required />
        </label>
        
        <label id="emailLabel">
          Primary Email
          <input type="email" id="attendee-email" name="email" required />
        </label>
        
        <label>
          Additional Emails (one per line)
          <textarea id="attendee-additional" name="additional_emails" rows="3" placeholder="friend@example.com&#10;colleague@work.com"></textarea>
          <small>These people will be CC'd on the invitation</small>
        </label>
        
        <label id="partySizeLabel">
          Party Size
          <input type="number" id="attendee-party-size" name="party_size" value="1" min="1" required />
        </label>
        
        <label id="sendInviteLabel">
          <input type="checkbox" id="attendee-send-invite" name="send_invite" value="1" />
          Send invite now
        </label>
        
        <footer class="grid">
          <button type="button" class="secondary" onclick="closeAttendeeModal()">Cancel</button>
          <button type="submit" id="attendeeSubmitBtn">Add & Send Invite Later</button>
        </footer>
      </form>
    </article>
  </dialog>

  <!-- Import Contacts Modal -->
  <dialog id="importContactsModal" onclick="if (event.target === this) closeImportContactsModal()">
    <article>
      <header>
        <button aria-label="Close" rel="prev" onclick="closeImportContactsModal()"></button>
        <h3>Invite many people</h3>
      </header>
      
      <details name="multi-add">
        <summary role="button" class="primary outline">Parse from Email</summary>
        <p><small>Paste a list of email recipients (like from an email's "To:" or "Cc:" field). Each will be added as a separate attendee with a party size of 1.</small></p>
        <form action="/admin/event/<%= event.id %>/attendees/parse-emails" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <label>
            Email Field Content
            <textarea name="email_field_data" rows="5" placeholder="&quot;Friendly Name&quot; &lt;name@example.com&gt;, another@example.org" required></textarea>
          </label>
          <button type="submit">Parse and Add</button>
        </form>
      </details>
      
      <details name="multi-add">
        <summary role="button" class="primary outline">Upload CSV/TSV File</summary>
        <p><small>Upload a CSV or TSV file with attendees. Each row should have at least one email address. The first non-email column will be used as the name.</small></p>
        <form action="/admin/event/<%= event.id %>/attendees/upload-csv" method="POST" enctype="multipart/form-data">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <label>
            CSV/TSV File
            <input type="file" name="csv_file" accept=".csv,.tsv,.txt" required />
          </label>
          <button type="submit">Upload and Add</button>
        </form>
      </details>
      
      <% if (allEvents.length > 0) { %>
      <details name="multi-add">
        <summary role="button" class="primary outline">Copy from Another Event</summary>
        <form action="/admin/attendees/copy" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" name="to_event" value="<%= event.id %>" />
          <label>
            Copy Attendees From
            <select name="from_event" required>
              <% allEvents.forEach(otherEvent => { %>
                <option value="<%= otherEvent.id %>"><%= otherEvent.title %></option>
              <% }) %>
            </select>
          </label>
          <button type="submit">Copy Attendees</button>
        </form>
      </details>
      <% } %>
    </article>
  </dialog>


  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <%- include('date-formatter-script') %>
  <!-- Admin JS -->
  <script src="/static/admin.js"></script>

  <script>
    // Initialize DataTables
    $(document).ready(function() {
      $('#attendeesTable').DataTable({
        "order": [[ 4, "desc" ]], // Default sort by "Last Modified" descending
        "pageLength": 25
      });
    });

    // Modal functions - Edit Event
    function openEditEventModal() {
      const modal = document.getElementById('editEventModal');
      const form = modal.querySelector('form');
      
      // Initialize date inputs from data-timestamp attributes
      initializeDateInputs(form);
      
      modal.showModal();
    }
    function closeEditEventModal() {
      document.getElementById('editEventModal').close();
    }

    // Modal functions - Unified Attendee Modal (Add/Edit)
    function openAddAttendeeModal() {
      const modal = document.getElementById('attendeeModal');
      const form = document.getElementById('attendeeForm');
      const title = document.getElementById('attendeeModalTitle');
      const submitBtn = document.getElementById('attendeeSubmitBtn');
      const emailLabel = document.getElementById('emailLabel');
      const sendInviteLabel = document.getElementById('sendInviteLabel');
      
      // Reset form
      form.reset();
      form.action = '/admin/attendee';
      
      // Set labels for add mode
      title.textContent = 'Invite Someone';
      submitBtn.textContent = 'Add Attendee';
      emailLabel.querySelector('input').name = 'email'; // Use 'email' for add
      document.getElementById('attendee-additional').name = 'additional_emails';
      
      // Show send invite checkbox
      sendInviteLabel.style.display = '';
      
      modal.showModal();
    }
    
    function openEditAttendeeModal(id, name, email, additionalEmails) {
      const modal = document.getElementById('attendeeModal');
      const form = document.getElementById('attendeeForm');
      const title = document.getElementById('attendeeModalTitle');
      const submitBtn = document.getElementById('attendeeSubmitBtn');
      const emailLabel = document.getElementById('emailLabel');
      const partySizeLabel = document.getElementById('partySizeLabel');
      const sendInviteLabel = document.getElementById('sendInviteLabel');
      
      // Set form action for edit
      form.action = `/admin/attendee/${id}/update-emails`;
      
      // Populate form fields
      document.getElementById('attendee-name').value = name;
      document.getElementById('attendee-email').value = email;
      document.getElementById('attendee-additional').value = additionalEmails;
      
      // Set labels for edit mode
      title.textContent = 'Edit Attendee Details';
      submitBtn.textContent = 'Save Changes';
      emailLabel.querySelector('input').name = 'primaryEmail'; // Use 'primaryEmail' for edit
      document.getElementById('attendee-additional').name = 'additionalEmails';
      
      // Hide party size and send invite for edit (they're handled separately)
      partySizeLabel.style.display = 'none';
      sendInviteLabel.style.display = 'none';
      
      modal.showModal();
    }
    
    function closeAttendeeModal() {
      const modal = document.getElementById('attendeeModal');
      const partySizeLabel = document.getElementById('partySizeLabel');
      partySizeLabel.style.display = ''; // Reset display
      modal.close();
    }

    // Modal functions - Import Contacts
    function openImportContactsModal() {
      document.getElementById('importContactsModal').showModal();
    }
    function closeImportContactsModal() {
      document.getElementById('importContactsModal').close();
    }
  </script>
</body>
</html>
