<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('header'); %>
  <title>Admin - <%= event.title %></title>
  <!-- DataTables CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    .current-banner-image {
      max-width: 300px;
      max-height: 200px;
      margin-top: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
    }
    /* Styles for the modal - Bulma should handle most of this */
    /* .modal { display: none; } /* Hidden by default, shown by JS */
    /* .modal.is-active { display: flex; } */ /* Bulma's way to show modal */
    .email-list small { display: block; margin-left: 10px; color: #555; }
  </style>
</head>
<body>
  <div class="container">
    <p><a href="/admin">&laquo; Back to All Events</a></p>
    <h1>Manage Event: <%= event.title %></h1>

    <!-- Edit Event Details Section -->
    <div class="form-section">
      <h2>Edit Event Details</h2>
      <% if (locals.error) { %>
        <p style="color: red;"><%= locals.error %></p>
      <% } %>
      <form action="/admin/event/<%= event.id %>/update" method="POST" enctype="multipart/form-data" id="editEventForm">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <div>
          <label for="title">Event Title:</label>
          <input type="text" id="title" name="title" value="<%= event.title %>" required />
        </div>
        <div>
          <label for="date">Start Date & Time:</label>
          <input type="datetime-local" id="date" name="date" data-timestamp="<%= event.date %>" required />
        </div>
        <div>
          <label for="date_end">End Date & Time (Optional):</label>
          <input type="datetime-local" id="date_end" name="date_end" data-timestamp="<%= event.date_end %>" />
        </div>
        <div>
          <label for="timezone">Event Timezone (Optional):</label>
          <select id="timezone" name="timezone">
            <option value="">Select Timezone (Uses server default if none)</option>
            <% if (typeof timezones !== 'undefined' && timezones.length > 0) { %>
              <% timezones.forEach(tz => { %>
                <option value="<%= tz %>" <%= (event.timezone === tz) ? 'selected' : '' %>><%= tz %></option>
              <% }); %>
            <% } else { %>
              <option value="" disabled>No timezones available</option>
            <% } %>
          </select>
        </div>
        <div>
          <label for="location_name">Location Name (Optional):</label>
          <input type="text" id="location_name" name="location_name" value="<%= event.location_name || '' %>" />
        </div>
        <div>
          <label for="location_href">Location URL (Optional):</label>
          <input type="url" id="location_href" name="location_href" value="<%= event.location_href || '' %>" placeholder="https://maps.example.com/..." />
        </div>
        <div>
          <label for="description">Description:</label>
          <textarea id="description" name="description" rows="3"><%= event.description || '' %></textarea>
        </div>
        <div>
          <label for="banner_image">Event Banner Image (Optional):</label>
          <% if (event.banner_image_filename) { %>
            <p>Current Banner:</p>
            <img src="/uploads/event-banners/<%= event.banner_image_filename %>" alt="Current Event Banner" class="current-banner-image">
            <p><small>Uploading a new image will replace the current one.</small></p>
          <% } else { %>
            <p><small>No banner image uploaded yet.</small></p>
          <% } %>
          <input type="file" id="banner_image" name="banner_image" accept="image/png, image/jpeg, image/gif">
        </div>
        <button type="submit" class="action-button">Update Event Details</button>
      </form>
    </div>
    <hr style="margin: 20px 0;">

    <p class="date">Current Start Date & Time (Server Local): <%= new Date(event.date).toLocaleString() %></p>
    <% if (event.date_end) { %>
      <p class="date">Current End Date & Time (Server Local): <%= new Date(event.date_end).toLocaleString() %></p>
    <% } %>
    <p class="timezone">Current Event Timezone for Emails: <%= event.timezone || 'Server Default' %></p>
    <% if (event.location_name || event.location_href) { %>
      <p class="location">
        Current Location: 
        <% if (event.location_href) { %>
          <a href="<%= event.location_href %>" target="_blank"><%= event.location_name || 'View Map' %></a>
        <% } else { %>
          <%= event.location_name %>
        <% } %>
      </p>
    <% } %>
    <% if (event.description) { %>
      <p class="description">Current Description: <%- event.description %></p>
    <% } %>


    <!-- RSVP Summary Section -->
    <% if (typeof attendeeStats !== 'undefined') { %>
    <div class="form-section">
      <h2>RSVP Summary</h2>
      <div class="summary-grid">
        <div class="summary-item"><strong>Potential Guests:</strong> <%= attendeeStats.potentialGuests %></div>
        <div class="summary-item"><strong>Invites Not Sent:</strong> <%= attendeeStats.guestsNotSent %></div>
        <div class="summary-item"><strong>Invites Sent:</strong> <%= attendeeStats.guestsInvited %></div>
      </div><div class="summary-grid">  <%# is there a better way to do this? %>
        <div class="summary-item"><strong>Awaiting Reply:</strong> <%= attendeeStats.guestsAwaitingReply %></div>
        <div class="summary-item"><strong>Attending:</strong> <%= attendeeStats.guestsAttending %></div>
        <div class="summary-item"><strong>Not Attending:</strong> <%= attendeeStats.guestsNotAttending %></div>
      </div>
    </div>
    <hr style="margin: 20px 0;">
    <% } %>

    <div class="form-section">
      <form action="/admin/events/<%= event.id %>/send-invites" method="POST" style="margin-bottom: 20px;">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <button type="submit" class="action-button" <% if (typeof attendeeStats !== 'undefined' && attendeeStats.guestsNotSent === 0) { %>disabled<% } %>>
          Send All Pending Invites for This Event
        </button>
        <% if (typeof attendeeStats !== 'undefined' && attendeeStats.guestsNotSent === 0) { %>
          <small>(No pending invites to send)</small>
        <% } %>
      </form>
    </div>


    <!-- Attendees Section -->
    <div class="form-section">
      <h2>Attendees for <%= event.title %></h2>

      <div class="grid-container">
        <div>
          <h3>Add Attendee</h3>
          <form action="/admin/attendee" method="POST">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <input type="hidden" name="event_id" value="<%= event.id %>" />
            <input type="hidden" name="token" />  <%# TODO: very beginning of turning this into an edit/update form as well as an insert form %>
            <label for="name">Name:</label>
            <input type="text" id="name" name="name" required />
            
            <label for="email">Primary Email:</label>
            <input type="email" id="email" name="email" required />
            
            <label for="additional_emails">Additional Emails (one per line or comma-separated):</label>
            <textarea id="additional_emails" name="additional_emails" rows="3" placeholder="friend@example.com, colleague@work.com"></textarea>
            
            <label for="party_size_single">Party Size:</label>
            <input type="number" id="party_size_single" name="party_size" value="1" min="1" required />
            <button type="submit">Add Attendee</button>
          </form>
        </div>

        <div style="visibility: hidden;"> <!-- todo: rethink this feature -->
          <h3>Batch Add Attendees (CSV)</h3>
          <form action="/admin/attendees/batch" method="POST">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <input type="hidden" name="event_id" value="<%= event.id %>" />
            <label for="csv">CSV Data (Name,Email,PartySize per line):</label>
            <textarea id="csv" name="csv" rows="5" placeholder="John Doe,john@example.com,2&#10;Jane Smith,jane@example.com,1" required></textarea>
            <button type="submit">Batch Add</button>
          </form>
        </div>
      </div>

      <!-- NEW: Parse Email Addresses from "To:" Field -->
      <div style="margin-top: 20px; margin-bottom: 20px;">
        <h3>Parse Email Addresses from "To:" Field</h3>
        <p style="font-size: 0.9em; color: #555; margin-bottom: 10px;">
          Paste a list of email recipients (e.g., from an email's "To:" or "Cc:" field).<br>
          Each will be added with a party size of 1. Deduplicates based on email address for this event.<br>
        </p>
        <form action="/admin/event/<%= event.id %>/attendees/parse-emails" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <label for="email_field_data">Paste Email Field Content:</label>
          <textarea id="email_field_data" name="email_field_data" rows="5" placeholder="&quot;Friendly Name&quot; &lt;name@example.com&gt;, another@example.org, Person &lt;person@server.com&gt;" required style="width: 100%; box-sizing: border-box; margin-top: 5px; margin-bottom: 10px;"></textarea>
          <button type="submit">Parse and Add Attendees</button>
        </form>
      </div>
      <!-- END NEW FORM SECTION -->

      <% if (allEvents.length > 0) { %>
      <div class="form-section" style="margin-top: 20px;"> 
        <h3>Copy Attendees to This Event (<%= event.title %>)</h3>
        <form action="/admin/attendees/copy" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" name="to_event" value="<%= event.id %>" />
          <label for="from_event">Copy Attendees From Event:</label>
          <select id="from_event" name="from_event" required>
            <% allEvents.forEach(otherEvent => { %>
              <option value="<%= otherEvent.id %>"><%= otherEvent.title %></option>
            <% }) %>
          </select>
          <button type="submit">Copy Attendees</button>
        </form>
      </div>
      <% } %>


      <h3>Responses</h3>
      <% if (attendees.length > 0) { %>
        <table id="attendeesTable" class="display">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email(s)</th>
              <th>Party Size</th>
              <th>Invite Sent?</th>
              <th>RSVP Status</th>
              <th>Responded At</th>
              <th>Last Modified</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% attendees.forEach(attendee => { %>
              <% 
                let additionalEmailsArray = [];
                if (attendee.additional_emails) {
                  try {
                    const parsed = JSON.parse(attendee.additional_emails);
                    if (Array.isArray(parsed)) {
                      additionalEmailsArray = parsed.filter(e => typeof e === 'string' && e.trim() !== '');
                    }
                  } catch(e) { /* ignore parsing error for data attribute */ }
                }
              %>
              <tr>
                <td><%= attendee.name %></td>
                <td class="email-list">
                  <strong><%= attendee.email %></strong> <!-- Primary -->
                  <% if (additionalEmailsArray.length > 0) { %>
                    <% additionalEmailsArray.forEach(addEmail => { %><small><%= addEmail %></small><% }); %>
                  <% } %>
                </td>
                <td data-order="<%= attendee.party_size %>">
                  <% if (!attendee.rsvp) { %>
                    <form action="/admin/attendee/<%= attendee.id %>/update-party-size" method="POST" class="party-size-form" style="display: inline-flex; align-items: center;">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <input type="number" name="party_size" value="<%= attendee.party_size %>" min="1" required style="width: 60px; margin-right: 5px;">
                      <button type="submit">Update</button>
                    </form>
                  <% } else { %>
                    <%= attendee.party_size %>
                  <% } %>
                </td>
                <td>
                  <% if (attendee.is_sent) { %>
                    <a href="/rsvp/<%= attendee.token %>" target="_blank">Yes</a>
                  <% } else { %>
                    No
                  <% } %>
                </td>
                <% 
                  let rsvpStatusText = 'Pending';
                  let rsvpSortOrder = 1; 
                  if (attendee.rsvp === 'yes') {
                    rsvpStatusText = 'YES';
                    rsvpSortOrder = 2;
                  } else if (attendee.rsvp === 'no') {
                    rsvpStatusText = 'NO';
                    rsvpSortOrder = 3;
                  }
                %>
                <td data-order="<%= rsvpSortOrder %>"><%= rsvpStatusText %></td>
                <td data-order="<%= attendee.responded_at || 0 %>">
                  <% if (attendee.responded_at) { %>
                    <%= new Date(attendee.responded_at).toLocaleString() %>
                  <% } else { %>
                    N/A
                  <% } %>
                </td>
                <td data-order="<%= attendee.last_modified || 0 %>">
                  <% if (attendee.last_modified) { %>
                    <%= new Date(attendee.last_modified).toLocaleString() %>
                  <% } else { %>
                    N/A
                  <% } %>
                </td>
                <td>
                  <% if (!attendee.is_sent) { %>
                    <form action="/admin/attendees/send/<%= attendee.id %>" method="POST" style="display: inline; margin-right: 5px;">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <button type="submit" class="action-button">Send Invite</button>
                    </form>
                  <% } else { %>
                    <form action="/admin/attendees/send/<%= attendee.id %>" method="POST" style="display: inline; margin-right: 5px;">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <input type="hidden" name="resend" value="1">
                      <button type="submit" class="action-button">Re-send Invite</button>
                    </form>
                  <% } %>
                  <button type="button" class="action-button edit-emails-button"
                          data-attendee-id="<%= attendee.id %>"
                          data-attendee-name="<%= attendee.name %>"
                          data-primary-email="<%= attendee.email %>"
                          data-additional-emails="<%= additionalEmailsArray.join('\n') %>">Edit Details</button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } else { %>
        <p>No attendees added yet for this event.</p>
      <% } %>
    </div>
  </div>

  <!-- Edit Details Modal -->
  <div id="editEmailsModal" class="modal"> <!-- Bulma: add 'is-active' to show -->
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Edit Details for <span id="modalAttendeeTitleName"></span></p>
        <button class="delete" aria-label="close" id="closeEditEmailsModalTop"></button>
      </header>
      <section class="modal-card-body">
        <form id="editEmailsForm" method="POST"> <!-- Action will be set by JS -->
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" id="modalAttendeeId" name="attendeeId">
          
          <div class="field">
            <label class="label" for="modalAttendeeNameInput">Name:</label>
            <div class="control">
              <input class="input" type="text" id="modalAttendeeNameInput" name="name" required>
            </div>
          </div>

          <div class="field">
            <label class="label" for="modalPrimaryEmail">Primary Email:</label>
            <div class="control">
              <input class="input" type="email" id="modalPrimaryEmail" name="primaryEmail" required>
            </div>
          </div>
          
          <div class="field">
            <label class="label" for="modalAdditionalEmails">Additional Emails (one per line):</label>
            <div class="control">
              <textarea class="textarea" id="modalAdditionalEmails" name="additionalEmails" rows="4"></textarea>
            </div>
          </div>
        </form>
      </section>
      <footer class="modal-card-foot">
        <button type="submit" class="button is-success" form="editEmailsForm">Save changes</button>
        <button type="button" class="button" id="cancelEditEmailsModalBottom">Cancel</button>
      </footer>
    </div>
  </div>


  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <script>
    // Helper function to format a Date object to YYYY-MM-DDTHH:MM for datetime-local input
    function formatDateToLocalInputString(date) {
      const year = date.getFullYear();
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // Helper function to handle form submission for date conversion
    function handleSubmitEventForm(event) {
      const form = event.target;
      // Select by current name, which is 'date' or 'date_end' before this script potentially renames them
      const dateInput = form.querySelector('input[name="date"]'); 
      const dateEndInput = form.querySelector('input[name="date_end"]');

      if (dateInput && dateInput.value) {
        const localDate = new Date(dateInput.value);
        if (!isNaN(localDate.getTime())) {
          const hiddenUtcDateInput = document.createElement('input');
          hiddenUtcDateInput.type = 'hidden';
          hiddenUtcDateInput.name = 'date'; // Keep original name for submission
          hiddenUtcDateInput.value = localDate.toISOString();
          form.appendChild(hiddenUtcDateInput);
          dateInput.name = 'date_display'; // Change name of original input
        } else {
          dateInput.name = 'date_display_invalid';
        }
      } else if (dateInput) {
        dateInput.name = 'date_display_empty';
      }

      if (dateEndInput && dateEndInput.value) {
        const localDateEnd = new Date(dateEndInput.value);
        if (!isNaN(localDateEnd.getTime())) {
          const hiddenUtcDateEndInput = document.createElement('input');
          hiddenUtcDateEndInput.type = 'hidden';
          hiddenUtcDateEndInput.name = 'date_end'; // Keep original name
          hiddenUtcDateEndInput.value = localDateEnd.toISOString();
          form.appendChild(hiddenUtcDateEndInput);
          dateEndInput.name = 'date_end_display'; // Change name
        } else {
          dateEndInput.name = 'date_end_display_invalid';
        }
      } else if (dateEndInput) {
        dateEndInput.name = 'date_end_display_empty';
      }
    }

    $(document).ready(function() {
      $('#attendeesTable').DataTable({
        "order": [[ 6, "desc" ]] // Default sort by "Last Modified" descending
      });

      // Populate datetime-local inputs for existing event using client's local timezone
      const dateInput = document.getElementById('date');
      const dateEndInput = document.getElementById('date_end');

      if (dateInput) {
        const timestamp = dateInput.dataset.timestamp;
        // Ensure timestamp is a valid number and not 'null' or 'undefined' string from EJS
        if (timestamp && timestamp !== 'null' && timestamp !== 'undefined' && !isNaN(Number(timestamp))) {
          dateInput.value = formatDateToLocalInputString(new Date(Number(timestamp)));
        } else {
          dateInput.value = ''; // Clear if no valid timestamp
        }
      }
      if (dateEndInput) {
        const timestampEnd = dateEndInput.dataset.timestamp;
        if (timestampEnd && timestampEnd !== 'null' && timestampEnd !== 'undefined' && !isNaN(Number(timestampEnd))) {
          dateEndInput.value = formatDateToLocalInputString(new Date(Number(timestampEnd)));
        } else {
          dateEndInput.value = ''; // Clear if no valid timestamp
        }
      }
      
      // Attach submit listener to the edit event form
      const editEventForm = document.getElementById('editEventForm');
      if (editEventForm) {
        editEventForm.addEventListener('submit', handleSubmitEventForm);
      }

      // Display errors from URL query params
      const urlParams = new URLSearchParams(window.location.search);
      const error = urlParams.get('error');
      if (error && !document.querySelector('.form-section p[style="color: red;"]')) { 
          const errorP = document.createElement('p');
          errorP.style.color = 'red';
          errorP.textContent = decodeURIComponent(error);
          // Try to insert error message after the H2 of the relevant form section
          // This is a bit generic; might need adjustment if multiple forms could show errors
          const activeFormH2 = document.querySelector('.form-section h2') || document.querySelector('.form-section h3');
          if (activeFormH2 && activeFormH2.parentNode) {
            activeFormH2.parentNode.insertBefore(errorP, activeFormH2.nextSibling);
          }
      }

      // Edit Details Modal Logic
      const editDetailsModalElement = document.getElementById('editEmailsModal'); // Keep ID for now, or rename if preferred
      const closeEditDetailsModalButtonTop = document.getElementById('closeEditEmailsModalTop');
      const cancelEditDetailsModalButtonBottom = document.getElementById('cancelEditEmailsModalBottom');
      const editDetailsFormElement = document.getElementById('editEmailsForm');
      const modalAttendeeTitleNameSpan = document.getElementById('modalAttendeeTitleName');
      const modalAttendeeIdInput = document.getElementById('modalAttendeeId');
      const modalAttendeeNameInput = document.getElementById('modalAttendeeNameInput'); // New input for name
      const modalPrimaryEmailInput = document.getElementById('modalPrimaryEmail');
      const modalAdditionalEmailsTextarea = document.getElementById('modalAdditionalEmails');

      // Use event delegation for edit buttons on the attendees table
      $('#attendeesTable tbody').on('click', '.edit-emails-button', function() {
          const attendeeId = $(this).data('attendee-id');
          const attendeeName = $(this).data('attendee-name');
          const primaryEmail = $(this).data('primary-email');
          const additionalEmails = $(this).data('additional-emails'); 

          modalAttendeeTitleNameSpan.textContent = attendeeName; // For the modal title
          modalAttendeeIdInput.value = attendeeId;
          modalAttendeeNameInput.value = attendeeName; // Populate the name input field
          modalPrimaryEmailInput.value = primaryEmail;
          modalAdditionalEmailsTextarea.value = additionalEmails;
          
          editDetailsFormElement.action = `/admin/attendee/${attendeeId}/update-emails`; // Route can remain for now
          
          if (editDetailsModalElement) { 
            editDetailsModalElement.classList.add('is-active');
          }
      });

      function closeEditDetailsModal() {
        if (editDetailsModalElement) { 
            editDetailsModalElement.classList.remove('is-active');
        }
      }

      if(closeEditDetailsModalButtonTop) closeEditDetailsModalButtonTop.addEventListener('click', closeEditDetailsModal);
      if(cancelEditDetailsModalButtonBottom) cancelEditDetailsModalButtonBottom.addEventListener('click', closeEditDetailsModal);
      
      const modalBackground = editDetailsModalElement ? editDetailsModalElement.querySelector('.modal-background') : null;
      if(modalBackground) modalBackground.addEventListener('click', closeEditDetailsModal);

    });
  </script>
</body>
</html>
