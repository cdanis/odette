<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/static/styles.css" />
  <title>Admin - <%= event.title %></title>
  <!-- DataTables CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }
    .summary-item {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 4px;
    }
    .summary-item strong {
      display: block;
      margin-bottom: 5px;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <p><a href="/admin">&laquo; Back to All Events</a></p>
    <h1>Manage Event: <%= event.title %></h1>

    <!-- Edit Event Details Section -->
    <div class="form-section">
      <h2>Edit Event Details</h2>
      <form action="/admin/event/<%= event.id %>/update" method="POST">
        <div>
          <label for="title">Event Title:</label>
          <input type="text" id="title" name="title" value="<%= event.title %>" required />
        </div>
        <div>
          <label for="date">Event Date:</label>
          <input type="date" id="date" name="date" value="<%= new Date(event.date).toISOString().split('T')[0] %>" required />
        </div>
        <div>
          <label for="description">Description:</label>
          <textarea id="description" name="description" rows="3"><%= event.description || '' %></textarea>
        </div>
        <button type="submit" class="action-button">Update Event Details</button>
      </form>
    </div>
    <hr style="margin: 20px 0;">

    <p class="date">Current Event Date: <%= new Date(event.date).toISOString() %></p>
    <% if (event.description) { %>
      <p class="description">Current Description: <%= event.description %></p>
    <% } %>

    <!-- RSVP Summary Section -->
    <% if (typeof attendeeStats !== 'undefined') { %>
    <div class="form-section">
      <h2>RSVP Summary</h2>
      <div class="summary-grid">
        <div class="summary-item"><strong>Potential Guests:</strong> <%= attendeeStats.potentialGuests %></div>
        <div class="summary-item"><strong>Invites Not Sent:</strong> <%= attendeeStats.guestsNotSent %></div>
        <div class="summary-item"><strong>Invites Sent:</strong> <%= attendeeStats.guestsInvited %></div>
        <div class="summary-item"><strong>Awaiting Reply:</strong> <%= attendeeStats.guestsAwaitingReply %></div>
        <div class="summary-item"><strong>Attending:</strong> <%= attendeeStats.guestsAttending %></div>
        <div class="summary-item"><strong>Not Attending:</strong> <%= attendeeStats.guestsNotAttending %></div>
      </div>
    </div>
    <hr style="margin: 20px 0;">
    <% } %>

    <div class="form-section">
      <form action="/admin/events/<%= event.id %>/send-invites" method="POST" style="margin-bottom: 20px;">
        <button type="submit" class="action-button" <% if (typeof attendeeStats !== 'undefined' && attendeeStats.guestsNotSent === 0) { %>disabled<% } %>>
          Send All Pending Invites for This Event
        </button>
        <% if (typeof attendeeStats !== 'undefined' && attendeeStats.guestsNotSent === 0) { %>
          <small>(No pending invites to send)</small>
        <% } %>
      </form>
    </div>


    <!-- Attendees Section -->
    <div class="form-section">
      <h2>Attendees for <%= event.title %></h2>

      <div class="grid-container">
        <div>
          <h3>Add Attendee</h3>
          <form action="/admin/attendee" method="POST">
            <input type="hidden" name="event_id" value="<%= event.id %>" />
            <label for="name">Name:</label>
            <input type="text" id="name" name="name" required />
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required />
            <label for="party_size_single">Party Size:</label>
            <input type="number" id="party_size_single" name="party_size" value="1" min="1" required />
            <button type="submit">Add Attendee</button>
          </form>
        </div>

        <div>
          <h3>Batch Add Attendees (CSV)</h3>
          <form action="/admin/attendees/batch" method="POST">
            <input type="hidden" name="event_id" value="<%= event.id %>" />
            <label for="csv">CSV Data (Name,Email,PartySize per line):</label>
            <textarea id="csv" name="csv" rows="5" placeholder="John Doe,john@example.com,2&#10;Jane Smith,jane@example.com,1" required></textarea>
            <button type="submit">Batch Add</button>
          </form>
        </div>
      </div>

      <% if (allEvents.length > 0) { %>
      <div class="form-section">
        <h3>Copy Attendees to This Event (<%= event.title %>)</h3>
        <form action="/admin/attendees/copy" method="POST">
          <input type="hidden" name="to_event" value="<%= event.id %>" />
          <label for="from_event">Copy Attendees From Event:</label>
          <select id="from_event" name="from_event" required>
            <% allEvents.forEach(otherEvent => { %>
              <option value="<%= otherEvent.id %>"><%= otherEvent.title %></option>
            <% }) %>
          </select>
          <button type="submit">Copy Attendees</button>
        </form>
      </div>
      <% } %>


      <h3>Current Attendees (<%= attendees.length %> individuals)</h3>
      <% if (attendees.length > 0) { %>
        <table id="attendeesTable" class="display">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Party Size</th>
              <th>Invite Sent?</th>
              <th>RSVP Status</th>
              <th>Responded At</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% attendees.forEach(attendee => { %>
              <tr>
                <td><%= attendee.name %></td>
                <td><%= attendee.email %></td>
                <td><%= attendee.party_size %></td>
                <td>
                  <% if (attendee.is_sent) { %>
                    <a href="/rsvp/<%= attendee.token %>" target="_blank">Yes</a>
                  <% } else { %>
                    No
                  <% } %>
                </td>
                <td><%= attendee.rsvp ? attendee.rsvp.toUpperCase() : 'Pending' %></td>
                <td>
                  <% if (attendee.responded_at) { %>
                    <%= new Date(attendee.responded_at).toLocaleString() %>
                  <% } else { %>
                    N/A
                  <% } %>
                </td>
                <td>
                  <% if (!attendee.is_sent) { %>
                    <form action="/admin/attendees/send/<%= attendee.id %>" method="POST" style="display: inline;">
                      <button type="submit" class="action-button">Send Invite</button>
                    </form>
                  <% } else { %>
                    <span>Sent</span>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } else { %>
        <p>No attendees added yet for this event.</p>
      <% } %>
    </div>
  </div>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <script>
    $(document).ready(function() {
      $('#attendeesTable').DataTable({
        // "columnDefs": [
        //   { "orderable": false, "targets": 6 } // Example: Disable sorting on 'Actions' column
        // ]
      });
    });
  </script>
</body>
</html>
