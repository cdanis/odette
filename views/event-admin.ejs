<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('header'); %>
  <title>Admin - <%= event.title %></title>
  <!-- DataTables CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    .current-banner-image {
      max-width: 300px;
      max-height: 200px;
      margin-top: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <%
    const formatDateToDateTimeLocalString = (dateInput) => {
      if (!dateInput) return ''; // Handles null, undefined, or empty string for optional dates
      const date = new Date(dateInput); 
      if (isNaN(date.getTime())) return ''; // Handle invalid dates
      
      const year = date.getFullYear();
      const month = (date.getMonth() + 1).toString().padStart(2, '0'); 
      const day = date.getDate().toString().padStart(2, '0');
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    };
  %>
  <div class="container">
    <p><a href="/admin">&laquo; Back to All Events</a></p>
    <h1>Manage Event: <%= event.title %></h1>

    <!-- Edit Event Details Section -->
    <div class="form-section">
      <h2>Edit Event Details</h2>
      <% if (locals.error) { %>
        <p style="color: red;"><%= locals.error %></p>
      <% } %>
      <form action="/admin/event/<%= event.id %>/update" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <div>
          <label for="title">Event Title:</label>
          <input type="text" id="title" name="title" value="<%= event.title %>" required />
        </div>
        <div>
          <label for="date">Start Date & Time:</label>
          <input type="datetime-local" id="date" name="date" value="<%= formatDateToDateTimeLocalString(event.date) %>" required />
        </div>
        <div>
          <label for="date_end">End Date & Time (Optional):</label>
          <input type="datetime-local" id="date_end" name="date_end" value="<%= formatDateToDateTimeLocalString(event.date_end) %>" />
        </div>
        <div>
          <label for="location_name">Location Name (Optional):</label>
          <input type="text" id="location_name" name="location_name" value="<%= event.location_name || '' %>" />
        </div>
        <div>
          <label for="location_href">Location URL (Optional):</label>
          <input type="url" id="location_href" name="location_href" value="<%= event.location_href || '' %>" placeholder="https://maps.example.com/..." />
        </div>
        <div>
          <label for="description">Description:</label>
          <textarea id="description" name="description" rows="3"><%= event.description || '' %></textarea>
        </div>
        <div>
          <label for="banner_image">Event Banner Image (Optional):</label>
          <% if (event.banner_image_filename) { %>
            <p>Current Banner:</p>
            <img src="/uploads/event-banners/<%= event.banner_image_filename %>" alt="Current Event Banner" class="current-banner-image">
            <p><small>Uploading a new image will replace the current one.</small></p>
          <% } else { %>
            <p><small>No banner image uploaded yet.</small></p>
          <% } %>
          <input type="file" id="banner_image" name="banner_image" accept="image/png, image/jpeg, image/gif">
        </div>
        <button type="submit" class="action-button">Update Event Details</button>
      </form>
    </div>
    <hr style="margin: 20px 0;">

    <p class="date">Current Start Date & Time: <%= new Date(event.date).toLocaleString() %></p>
    <% if (event.date_end) { %>
      <p class="date">Current End Date & Time: <%= new Date(event.date_end).toLocaleString() %></p>
    <% } %>
    <% if (event.location_name || event.location_href) { %>
      <p class="location">
        Current Location: 
        <% if (event.location_href) { %>
          <a href="<%= event.location_href %>" target="_blank"><%= event.location_name || 'View Map' %></a>
        <% } else { %>
          <%= event.location_name %>
        <% } %>
      </p>
    <% } %>
    <% if (event.description) { %>
      <p class="description">Current Description: <%= event.description %></p>
    <% } %>


    <!-- RSVP Summary Section -->
    <% if (typeof attendeeStats !== 'undefined') { %>
    <div class="form-section">
      <h2>RSVP Summary</h2>
      <div class="summary-grid">
        <div class="summary-item"><strong>Potential Guests:</strong> <%= attendeeStats.potentialGuests %></div>
        <div class="summary-item"><strong>Invites Not Sent:</strong> <%= attendeeStats.guestsNotSent %></div>
        <div class="summary-item"><strong>Invites Sent:</strong> <%= attendeeStats.guestsInvited %></div>
      </div><div class="summary-grid">  <%# is there a better way to do this? %>
        <div class="summary-item"><strong>Awaiting Reply:</strong> <%= attendeeStats.guestsAwaitingReply %></div>
        <div class="summary-item"><strong>Attending:</strong> <%= attendeeStats.guestsAttending %></div>
        <div class="summary-item"><strong>Not Attending:</strong> <%= attendeeStats.guestsNotAttending %></div>
      </div>
    </div>
    <hr style="margin: 20px 0;">
    <% } %>

    <div class="form-section">
      <form action="/admin/events/<%= event.id %>/send-invites" method="POST" style="margin-bottom: 20px;">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <button type="submit" class="action-button" <% if (typeof attendeeStats !== 'undefined' && attendeeStats.guestsNotSent === 0) { %>disabled<% } %>>
          Send All Pending Invites for This Event
        </button>
        <% if (typeof attendeeStats !== 'undefined' && attendeeStats.guestsNotSent === 0) { %>
          <small>(No pending invites to send)</small>
        <% } %>
      </form>
    </div>


    <!-- Attendees Section -->
    <div class="form-section">
      <h2>Attendees for <%= event.title %></h2>

      <div class="grid-container">
        <div>
          <h3>Add Attendee</h3>
          <form action="/admin/attendee" method="POST">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <input type="hidden" name="event_id" value="<%= event.id %>" />
            <input type="hidden" name="token" />  <%# TODO: very beginning of turning this into an edit/update form as well as an insert form %>
            <label for="name">Name:</label>
            <input type="text" id="name" name="name" required />
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required />
            <label for="party_size_single">Party Size:</label>
            <input type="number" id="party_size_single" name="party_size" value="1" min="1" required />
            <button type="submit">Add Attendee</button>
          </form>
        </div>

        <div style="visibility: hidden;"> <!-- todo: rethink this feature -->
          <h3>Batch Add Attendees (CSV)</h3>
          <form action="/admin/attendees/batch" method="POST">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <input type="hidden" name="event_id" value="<%= event.id %>" />
            <label for="csv">CSV Data (Name,Email,PartySize per line):</label>
            <textarea id="csv" name="csv" rows="5" placeholder="John Doe,john@example.com,2&#10;Jane Smith,jane@example.com,1" required></textarea>
            <button type="submit">Batch Add</button>
          </form>
        </div>
      </div>

      <!-- NEW: Parse Email Addresses from "To:" Field -->
      <div style="margin-top: 20px; margin-bottom: 20px;">
        <h3>Parse Email Addresses from "To:" Field</h3>
        <p style="font-size: 0.9em; color: #555; margin-bottom: 10px;">
          Paste a list of email recipients (e.g., from an email's "To:" or "Cc:" field).<br>
          Each will be added with a party size of 1. Deduplicates based on email address for this event.<br>
        </p>
        <form action="/admin/event/<%= event.id %>/attendees/parse-emails" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <label for="email_field_data">Paste Email Field Content:</label>
          <textarea id="email_field_data" name="email_field_data" rows="5" placeholder="&quot;Friendly Name&quot; &lt;name@example.com&gt;, another@example.org, Person &lt;person@server.com&gt;" required style="width: 100%; box-sizing: border-box; margin-top: 5px; margin-bottom: 10px;"></textarea>
          <button type="submit">Parse and Add Attendees</button>
        </form>
      </div>
      <!-- END NEW FORM SECTION -->

      <% if (allEvents.length > 0) { %>
      <div class="form-section" style="margin-top: 20px;"> 
        <h3>Copy Attendees to This Event (<%= event.title %>)</h3>
        <form action="/admin/attendees/copy" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" name="to_event" value="<%= event.id %>" />
          <label for="from_event">Copy Attendees From Event:</label>
          <select id="from_event" name="from_event" required>
            <% allEvents.forEach(otherEvent => { %>
              <option value="<%= otherEvent.id %>"><%= otherEvent.title %></option>
            <% }) %>
          </select>
          <button type="submit">Copy Attendees</button>
        </form>
      </div>
      <% } %>


      <h3>Responses</h3>
      <% if (attendees.length > 0) { %>
        <table id="attendeesTable" class="display">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Party Size</th>
              <th>Invite Sent?</th>
              <th>RSVP Status</th>
              <th>Responded At</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% attendees.forEach(attendee => { %>
              <tr>
                <td><%= attendee.name %></td>
                <td><%= attendee.email %></td>
                <td data-order="<%= attendee.party_size %>">
                  <% if (!attendee.rsvp) { %>
                    <form action="/admin/attendee/<%= attendee.id %>/update-party-size" method="POST" class="party-size-form" style="display: inline-flex; align-items: center;">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <input type="number" name="party_size" value="<%= attendee.party_size %>" min="1" required style="width: 60px; margin-right: 5px;">
                      <button type="submit">Update</button>
                    </form>
                  <% } else { %>
                    <%= attendee.party_size %>
                  <% } %>
                </td>
                <td>
                  <% if (attendee.is_sent) { %>
                    <a href="/rsvp/<%= attendee.token %>" target="_blank">Yes</a>
                  <% } else { %>
                    No
                  <% } %>
                </td>
                <% 
                  let rsvpStatusText = 'Pending';
                  let rsvpSortOrder = 1; 
                  if (attendee.rsvp === 'yes') {
                    rsvpStatusText = 'YES';
                    rsvpSortOrder = 2;
                  } else if (attendee.rsvp === 'no') {
                    rsvpStatusText = 'NO';
                    rsvpSortOrder = 3;
                  }
                %>
                <td data-order="<%= rsvpSortOrder %>"><%= rsvpStatusText %></td>
                <td>
                  <% if (attendee.responded_at) { %>
                    <%= new Date(attendee.responded_at).toLocaleString() %>
                  <% } else { %>
                    N/A
                  <% } %>
                </td>
                <td>
                  <% if (!attendee.is_sent) { %>
                    <form action="/admin/attendees/send/<%= attendee.id %>" method="POST" style="display: inline;">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <button type="submit" class="action-button">Send Invite</button>
                    </form>
                  <% } else { %>
                    <span>Sent</span>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } else { %>
        <p>No attendees added yet for this event.</p>
      <% } %>
    </div>
  </div>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <script>
    $(document).ready(function() {
      $('#attendeesTable').DataTable({
      });
      const urlParams = new URLSearchParams(window.location.search);
      const error = urlParams.get('error');
      if (error && !document.querySelector('.form-section p[style="color: red;"]')) { 
          const errorP = document.createElement('p');
          errorP.style.color = 'red';
          errorP.textContent = decodeURIComponent(error);
          const formSectionH2 = document.querySelector('.form-section h2'); 
          if (formSectionH2 && formSectionH2.parentNode) {
            formSectionH2.parentNode.insertBefore(errorP, formSectionH2.nextSibling);
          }
      }
    });
  </script>
</body>
</html>
