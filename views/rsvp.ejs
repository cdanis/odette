<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('header'); %>
    <title>
        RSVP - <%= attendee.event_title %>
    </title>
    <style>
        .event-banner {
            width: 100%;
            max-height: 300px; /* Adjust as needed */
            object-fit: cover; /* Crop image to fit, maintaining aspect ratio */
            margin-bottom: 1rem;
            border-radius: 3px; /* Optional: if your card has rounded corners */
        }
        .card {
            /* Ensure card can contain the image nicely */
            overflow: hidden; /* If banner is first child and has different radius */
        }
        .event-time, .event-location { margin-bottom: 0.5rem; }
    </style>
</head>

<body>
    <div class="container">
        <div class="card">  <%# todo: separate to a sub-'component' template %>
            <% if (attendee.event_banner_image_filename) { %>
                <img src="/static/uploads/event-banners/<%= attendee.event_banner_image_filename %>" alt="<%= attendee.event_title %> Banner" class="event-banner">
            <% } %>
            <div class="card-header">
                <h1 class="card-header-title">
                    <%= attendee.event_title %>
                </h1>
            </div>
            <div class="event-time">
                <strong>When:</strong> 
                <span id="event-start-time" class="local-datetime" data-timestamp="<%= attendee.event_date %>">
                    <%= new Date(attendee.event_date).toLocaleString() %>
                </span>
                <% if (attendee.event_date_end) { %>
                    to <span id="event-end-time" class="local-datetime" data-timestamp="<%= attendee.event_date_end %>">
                        <%= new Date(attendee.event_date_end).toLocaleString() %>
                    </span>
                <% } %>
            </div>
            <% if (attendee.event_location_name || attendee.event_location_href) { %>
                <div class="event-location">
                    <strong>Where:</strong>
                    <% if (attendee.event_location_href) { %>
                        <a href="<%= attendee.event_location_href %>" target="_blank"><%= attendee.event_location_name || 'View Map' %></a>
                    <% } else { %>
                        <%= attendee.event_location_name %>
                    <% } %>
                </div>
            <% } %>
            <% if (attendee.event_desc) { %>
                <p class="description"><%- attendee.event_desc %></p>
            <% } %>
        </div>

        <%# todo: htmx island %>
        <form action="/rsvp/<%= attendee.token %>" method="POST" class="rsvp-form">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <label for="name_disabled">
                Your Name:
                <input type="text" id="name_disabled" name="name_display" value="<%= attendee.name %>" disabled />
            </label>
            <fieldset>
                <legend>Will you attend?</legend>
                <label><input type="radio" name="rsvp" value="yes" <% if (attendee.rsvp==='yes' ) { %>checked<% } %>
                        required /> Yes</label>
                <label><input type="radio" name="rsvp" value="no" <% if (attendee.rsvp==='no' ) { %>checked<% } %> />
                        No</label>
            </fieldset>
            <label for="party_size_rsvp">
                Total people attending:
                <input type="number" id="party_size_rsvp" name="party_size" min="1" value="<%= attendee.party_size %>"
                    required />
            </label>
            <button class="button is-primary" type="submit">Respond</button>
        </form>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/dayjs.min.js" integrity="sha512-FwNWaxyfy2XlEINoSnZh1JQ5TRRtGow0D6XcmAWmYCRgvqOUTnzCxPc9uF35u5ZEpirk1uhlPVA19tflhvnW1g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/plugin/utc.min.js" integrity="sha512-z84O912dDT9nKqvpBnl1tri5IN0j/OEgMzLN1GlkpKLMscs5ZHVu+G2CYtA6dkS0YnOGi3cODt3BOPnYc8Agjg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/plugin/timezone.min.js" integrity="sha512-nrkE2nl0pcqWefIY627DY1exPOSuZXMdOrxMxX0y7Ly6RH8K0WDjO1lqakkxQcX5m8hxoUSt75seRRiyhqPvIw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/plugin/localizedFormat.min.js" integrity="sha512-vjS0MkqX58pv35Mv03gzee3TSJ74Gg5lPkgel1V8czy+sTX/ZoFMs/FqnGzWpf3IV+Ry3/mJ0i9nANcjKk1fBg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/plugin/isSameOrBefore.min.js" integrity="sha512-876cPC20xdc0h0OI0Cjpll3uG3WJ2Y6tk2r59Y2LDG2XhWZXChE9GAb1UqkzBRNIn3s9N1yP7U02AQoW7JjYAg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/plugin/isSameOrAfter.min.js" integrity="sha512-f3WgCJaL8N0hK2hWIFgS2XhQnAljQJ0X3oJ6IChP2SbT62D0rG4L0E8xPzNnSylwLh3hG2zXhY3AEkL8sMRsA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        dayjs.extend(dayjs_plugin_utc);
        dayjs.extend(dayjs_plugin_timezone);
        dayjs.extend(dayjs_plugin_localizedFormat);
        dayjs.extend(dayjs_plugin_isSameOrBefore); // Though isSame is part of core, explicit for clarity if needed elsewhere
        dayjs.extend(dayjs_plugin_isSameOrAfter);  // Same as above

        document.addEventListener('DOMContentLoaded', () => {
            const startTimeEl = document.getElementById('event-start-time');
            const endTimeEl = document.getElementById('event-end-time');

            let startDate;

            if (startTimeEl) {
                const startTimestamp = startTimeEl.dataset.timestamp;
                if (startTimestamp && !isNaN(Number(startTimestamp))) {
                    startDate = dayjs(Number(startTimestamp));
                    startTimeEl.textContent = startDate.format('dddd, MMMM D, YYYY LT');
                }
            }

            if (endTimeEl && startDate) { // Ensure startDate is valid before processing endTime
                const endTimestamp = endTimeEl.dataset.timestamp;
                if (endTimestamp && !isNaN(Number(endTimestamp))) {
                    const endDate = dayjs(Number(endTimestamp));
                    if (startDate.isSame(endDate, 'day')) {
                        endTimeEl.textContent = endDate.format('LT'); // Only time
                    } else {
                        endTimeEl.textContent = endDate.format('dddd, MMMM D, YYYY LT'); // Full date and time
                    }
                }
            }
            
            // Fallback for any other .local-datetime elements (if any were added elsewhere)
            // This ensures they are still formatted if not specifically handled above.
            document.querySelectorAll('.local-datetime:not(#event-start-time):not(#event-end-time)').forEach(el => {
                const timestamp = el.dataset.timestamp;
                if (timestamp && !isNaN(Number(timestamp))) {
                    el.textContent = dayjs(Number(timestamp)).format('dddd, MMMM D, YYYY LT');
                }
            });

            const rsvpRadios = document.querySelectorAll('input[name="rsvp"]');
            const partySizeInput = document.getElementById('party_size_rsvp');

            function togglePartySize() {
                if (document.querySelector('input[name="rsvp"][value="no"]:checked')) {
                    partySizeInput.disabled = true;
                    partySizeInput.style.backgroundColor = '#e9ecef'; 
                } else {
                    partySizeInput.disabled = false;
                    partySizeInput.style.backgroundColor = '';
                }
            }
            rsvpRadios.forEach(radio => radio.addEventListener('change', togglePartySize));
            togglePartySize(); 
        });
    </script>
</body>

</html>
