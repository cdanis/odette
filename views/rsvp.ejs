<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('header'); %>
    <title>
        you're invited: <%= attendee.event_title %>
    </title>

    <style>
        .event-banner {
            width: 100%;
            object-fit: contain;
            max-height: 90vh;
        }
        @media (max-width: 1024px) {
            .event-banner {
                max-height: 60vh;
            }
        }
    </style>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
</head>

<body>
    <main class="container">
        <div class="grid">
            <% if (attendee.event_banner_image_filename) { %>
                <figure><img src="/uploads/event-banners/<%= attendee.event_banner_image_filename %>"
                        alt="<%= attendee.event_title %> Banner" class="event-banner"></figure>
            <% } %>

            <article>
                <header>
                    <h2>
                        <%= attendee.event_title %>
                    </h2>
                </header>
                <section>
                <div class="add-to-calendar-container" style="margin-top: 0; margin-bottom: 0.5rem;">
                    <a href="/ics/<%= attendee.token %>" role="button" download>
                        <span>ðŸ“… Add to Calendar</span>
                    </a>
                </div>
                <div style="padding-bottom: 0.33rem;">
                    <div>
                        <span id="event-start-time" class="local-datetime"
                            data-timestamp="<%= attendee.event_date %>">
                            <%= new Date(attendee.event_date).toLocaleString() %>
                        </span>
                    </div>
                    <div>
                        <% if (attendee.event_location_name || attendee.event_location_href) { %>
                            <% if (attendee.event_location_href) { %>
                                <a href="<%= attendee.event_location_href %>" target="_blank">
                                    <%= attendee.event_location_name || 'Location' %>
                                </a>
                            <% } else { %>
                                <%= attendee.event_location_name %>
                            <% } %>
                        <% } %>
                    </div>
                </div>
            </section>
            <% if (attendee.event_desc) { %>
                <section>
                    <p class="description"><%- attendee.event_desc %></p>
                </section>
            <% } %>
            <hr />
            <section>
                <form action="/rsvp/<%= attendee.token %>" method="POST" class="rsvp-form">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <label>
                    You are:
                    <input type="text" name="name_display" value="<%= attendee.name %>" disabled />
                </label>
                <fieldset>
                    <legend>Will you attend?</legend>
                    <label><input type="radio" name="rsvp" value="yes" <% if (attendee.rsvp==='yes') { %>checked<% } %>
                            required /> Yes</label>
                    <label><input type="radio" name="rsvp" value="no" <% if (attendee.rsvp==='no') { %>checked<% } %>
                            />
                            No</label>
                </fieldset>
                <label for="party_size_rsvp">
                    Total people in your group (including you!):
                    <input type="number" id="party_size_rsvp" name="party_size" min="1"
                        value="<%= attendee.party_size %>" required />
                </label>
                <input type="submit" value="Respond ðŸ“©"/>
            </form>

            </section>
            </article>
        </div>
    </main>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/dayjs.min.js"
        integrity="sha512-FwNWaxyfy2XlEINoSnZh1JQ5TRRtGow0D6XcmAWmYCRgvqOUTnzCxPc9uF35u5ZEpirk1uhlPVA19tflhvnW1g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/plugin/utc.min.js"
        integrity="sha512-z84O912dDT9nKqvpBnl1tri5IN0j/OEgMzLN1GlkpKLMscs5ZHVu+G2CYtA6dkS0YnOGi3cODt3BOPnYc8Agjg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/plugin/timezone.min.js"
        integrity="sha512-nrkE2nl0pcqWefIY627DY1exPOSuZXMdOrxMxX0y7Ly6RH8K0WDjO1lqakkxQcX5m8hxoUSt75seRRiyhqPvIw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/plugin/localizedFormat.min.js"
        integrity="sha512-vjS0MkqX58pv35Mv03gzee3TSJ74Gg5lPkgel1V8czy+sTX/ZoFMs/FqnGzWpf3IV+Ry3/mJ0i9nANcjKk1fBg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/plugin/isSameOrBefore.min.js"
        integrity="sha512-QrDN35Hb2sRTjFOKNIMLrX6SrjsJBlBE1+WAZnXJPEfGlYiPRgmN8oE9Uvz/5S+h55lmp/Jsiq1gHfCDAquXWA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/plugin/isSameOrAfter.min.js"
        integrity="sha512-8gn84sM7ampZwKjmwm8+y8/FpiPbFVgJGqR5Aio1Lx2T08tEvmJQ5ffLWQFnjDkD/c4kzxebsVtJFswTIvvT+g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof dayjs === 'undefined') {
                console.error('Day.js library is not loaded. Date formatting will use browser defaults.');
                return; // Exit if dayjs is not available
            }

            // Extend dayjs with necessary plugins
            dayjs.extend(dayjs_plugin_utc);
            dayjs.extend(dayjs_plugin_timezone);
            dayjs.extend(dayjs_plugin_localizedFormat);
            dayjs.extend(dayjs_plugin_isSameOrBefore);
            dayjs.extend(dayjs_plugin_isSameOrAfter);

            const startTimeEl = document.getElementById('event-start-time');
            const endTimeEl = document.getElementById('event-end-time');

            let startDate;

            if (startTimeEl) {
                const startTimestamp = startTimeEl.dataset.timestamp;
                if (startTimestamp && !isNaN(Number(startTimestamp))) {
                    startDate = dayjs(Number(startTimestamp));
                    if (startDate.isValid()) {
                        startTimeEl.textContent = startDate.format('dddd, MMMM D, YYYY LT');
                    } else {
                        console.error('Parsed start date is invalid. Timestamp:', startTimestamp);
                        // Keep server-rendered if startDate is invalid
                    }
                } else {
                    console.error('Start timestamp is missing or invalid. Value:', startTimestamp);
                }
            }

            if (endTimeEl && startDate && startDate.isValid()) {
                const endTimestamp = endTimeEl.dataset.timestamp;
                if (endTimestamp && !isNaN(Number(endTimestamp))) {
                    const endDate = dayjs(Number(endTimestamp));
                    if (endDate.isValid()) {
                        if (startDate.isSame(endDate, 'day')) {
                            endTimeEl.textContent = endDate.format('LT');
                        } else {
                            endTimeEl.textContent = endDate.format('dddd, MMMM D, YYYY LT');
                        }
                    } else {
                        console.error('Parsed end date is invalid. Timestamp:', endTimestamp);
                        // Keep server-rendered if endDate is invalid
                    }
                } else {
                    console.error('End timestamp is missing or invalid. Value:', endTimestamp);
                }
            }

            // Fallback for any other .local-datetime elements that are not the main start/end times
            document.querySelectorAll('.local-datetime:not(#event-start-time):not(#event-end-time)').forEach(el => {
                const timestamp = el.dataset.timestamp;
                if (timestamp && !isNaN(Number(timestamp))) {
                    const date = dayjs(Number(timestamp));
                    if (date.isValid()) {
                        el.textContent = date.format('dddd, MMMM D, YYYY LT');
                    } else {
                        console.error('Invalid timestamp in a .local-datetime element:', timestamp);
                    }
                }
            });

            const rsvpRadios = document.querySelectorAll('input[name="rsvp"]');
            const partySizeInput = document.getElementById('party_size_rsvp');

            function togglePartySize() {
                if (document.querySelector('input[name="rsvp"][value="no"]:checked')) {
                    partySizeInput.disabled = true;
                    partySizeInput.style.backgroundColor = '#e9ecef';
                } else {
                    partySizeInput.disabled = false;
                    partySizeInput.style.backgroundColor = '';
                }
            }
            rsvpRadios.forEach(radio => radio.addEventListener('change', togglePartySize));
            togglePartySize();
        });
    </script>
</body>

</html>
